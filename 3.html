<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" style="max-width: 600px;">
        <div class="header">
            <h1 id="welcome-message">Welcome, Student!</h1>
        </div>

        <div class="dashboard-card">
            <h3>My Details</h3>
            <p><strong>Class:</strong> <span id="student-class"></span></p>
            <p><strong>Email:</strong> <span id="student-email"></span></p>
        </div>

        <div class="dashboard-card">
            <h3>My Attendance</h3>
            <p id="attendance-info">Loading...</p>
        </div>

        <div class="dashboard-card">
            <h3>My Test Marks</h3>
            <div id="test-marks-info">Loading...</div>
        </div>
        
        <div class="dashboard-card">
            <h3>Class Resources</h3>
            <div id="resource-links">Loading...</div>
        </div>

        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    
    <!-- Local Scripts -->
    <script src="data.js"></script>
    <script src="app.js"></script>
    <script>
        auth.onAuthStateChanged(user => {
            if (user) {
                const uid = user.uid;
                const userRef = db.collection('users').doc(uid);

                // Fetch user data
                userRef.get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('welcome-message').textContent = `Welcome, ${userData.name}!`;
                        document.getElementById('student-class').textContent = userData.class;
                        document.getElementById('student-email').textContent = userData.email;
                        
                        // Load resources from data.js
                        const resources = resourceLinks[userData.class];
                        const linksContainer = document.getElementById('resource-links');
                        if(resources){
                            let linksHtml = '';
                            for (const subject in resources) {
                                linksHtml += `<a href="${resources[subject]}" target="_blank" class="link">${subject} Materials</a><br>`;
                            }
                            linksContainer.innerHTML = linksHtml;
                        } else {
                            linksContainer.innerHTML = 'No resources found for your class.';
                        }
                    }
                });

                // Fetch attendance
                db.collection('attendance').where('studentId', '==', uid).get().then(snapshot => {
                    if (snapshot.empty) {
                        document.getElementById('attendance-info').textContent = 'No attendance records found.';
                        return;
                    }
                    let present = 0;
                    let total = snapshot.size;
                    snapshot.forEach(doc => {
                        if (doc.data().status === 'present') present++;
                    });
                    document.getElementById('attendance-info').textContent = `Present on ${present} out of ${total} days. (${((present/total)*100).toFixed(1)}%)`;
                });

                // Fetch test marks
                db.collection('tests').where('studentId', '==', uid).get().then(snapshot => {
                     const marksContainer = document.getElementById('test-marks-info');
                    if (snapshot.empty) {
                        marksContainer.textContent = 'No test records found.';
                        return;
                    }
                    let marksHtml = '';
                    snapshot.forEach(doc => {
                        const test = doc.data();
                        marksHtml += `<p><strong>${test.testName}:</strong> ${test.marksObtained} / ${test.totalMarks}</p>`;
                    });
                    marksContainer.innerHTML = marksHtml;
                });

            } else {
                window.location.replace('1.html');
            }
        });
    </script>
</body>
</html>
