<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" style="max-width: 800px; text-align: left;">
        <div class="header">
            <h1>Admin Panel</h1>
            <button class="btn-secondary" onclick="logout()">Logout</button>
        </div>

        <div id="admin-content" style="display: none;">
            <!-- Add Teacher -->
            <div class="dashboard-card">
                <h3>Add New Teacher</h3>
                <form id="add-teacher-form">
                    <input type="text" id="teacher-name" placeholder="Teacher Name" class="form-input" required>
                    <input type="text" id="teacher-subject" placeholder="Subject" class="form-input" style="margin-top: 10px;" required>
                    <input type="text" id="teacher-class" placeholder="Class (e.g., 9, 10)" class="form-input" style="margin-top: 10px;" required>
                    <input type="tel" id="teacher-mobile" placeholder="Mobile Number" class="form-input" style="margin-top: 10px;" required>
                    <input type="email" id="teacher-email" placeholder="Teacher Email (for login)" class="form-input" style="margin-top: 10px;" required>
                    <input type="password" id="teacher-password" placeholder="Temporary Password" class="form-input" style="margin-top: 10px;" required>
                    <button type="submit" class="btn" style="margin-top: 10px;">Add Teacher</button>
                </form>
            </div>

            <!-- Manage Student Data -->
            <div class="dashboard-card">
                <h3>Manage Student Data</h3>
                <div class="form-group">
                    <label for="student-select">Select Student</label>
                    <select id="student-select" class="form-input"></select>
                </div>
                
                <!-- Add Attendance -->
                <h4>Add Attendance</h4>
                <form id="add-attendance-form" style="display: flex; gap: 10px; align-items:center;">
                    <input type="date" id="attendance-date" class="form-input" required>
                    <select id="attendance-status" class="form-input" required>
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                    </select>
                    <button type="submit" class="btn">Save</button>
                </form>

                <!-- Add Test Marks -->
                <h4 style="margin-top: 1.5rem;">Add Test Marks</h4>
                 <form id="add-marks-form" style="display: flex; gap: 10px; align-items:center;">
                    <input type="text" id="test-name" placeholder="Test Name (e.g., Weekly Test 1)" class="form-input" required>
                    <input type="number" id="marks-obtained" placeholder="Marks" class="form-input" required>
                    <input type="number" id="total-marks" placeholder="Total" class="form-input" required>
                    <button type="submit" class="btn">Save</button>
                </form>
            </div>
             <p id="admin-message" style="color: green;"></p>
        </div>
        <p id="loading-message">Verifying access...</p>
    </div>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    
    <!-- Local Scripts -->
    <script src="app.js"></script>
    <script>
        const adminContent = document.getElementById('admin-content');
        const loadingMessage = document.getElementById('loading-message');
        const studentSelect = document.getElementById('student-select');
        const adminMessage = document.getElementById('admin-message');

        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().role === 'admin') {
                        loadingMessage.style.display = 'none';
                        adminContent.style.display = 'block';
                        loadStudents();
                    } else {
                        alert("Access Denied. You are not an admin.");
                        window.location.replace('1.html');
                    }
                });
            } else {
                window.location.replace('1.html');
            }
        });
        
        function showAdminMessage(msg) {
            adminMessage.textContent = msg;
            setTimeout(() => adminMessage.textContent = '', 3000);
        }

        function loadStudents() {
            db.collection('users').where('role', '==', 'student').get().then(snapshot => {
                studentSelect.innerHTML = '';
                snapshot.forEach(doc => {
                    const student = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${student.name} - Class ${student.class}`;
                    studentSelect.appendChild(option);
                });
            });
        }

        // Add Teacher Logic (Note: This creates a new auth user, which is complex. For a real app, use Firebase Admin SDK on a server)
        document.getElementById('add-teacher-form').addEventListener('submit', e => {
            e.preventDefault();
            // This is a simplified client-side approach. In production, this logic should be on a secure server.
            showAdminMessage('Teacher creation is a complex feature requiring a server-side environment (Firebase Functions) to be secure. This is a UI demonstration.');
             // Logic to add to Firestore would go here, but creating a new auth user from the client is a security risk.
            e.target.reset();
        });

        // Add Attendance
        document.getElementById('add-attendance-form').addEventListener('submit', e => {
            e.preventDefault();
            const studentId = studentSelect.value;
            const date = document.getElementById('attendance-date').value;
            const status = document.getElementById('attendance-status').value;
            
            db.collection('attendance').add({
                studentId,
                date,
                status,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                showAdminMessage('Attendance saved successfully!');
                e.target.reset();
            }).catch(err => showAdminMessage(`Error: ${err.message}`));
        });

        // Add Marks
        document.getElementById('add-marks-form').addEventListener('submit', e => {
            e.preventDefault();
            const studentId = studentSelect.value;
            const testName = document.getElementById('test-name').value;
            const marksObtained = document.getElementById('marks-obtained').value;
            const totalMarks = document.getElementById('total-marks').value;

            db.collection('tests').add({
                studentId,
                testName,
                marksObtained: parseInt(marksObtained),
                totalMarks: parseInt(totalMarks),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                showAdminMessage('Marks saved successfully!');
                e.target.reset();
            }).catch(err => showAdminMessage(`Error: ${err.message}`));
        });
    </script>
</body>
</html>
